# VIS Decoder Analysis - MMSSTV vs mmsstv-portable

## Analysis of Original MMSSTV Code

### VIS Decoder Implementation in MMSSTV (sstv.cpp lines 1974-2010)

**Key Findings:**

1. **Frequencies:**
   - Mark (bit=1): **1080 Hz** (not 1100 Hz as in spec)
   - Space (bit=0): **1320 Hz** (not 1300 Hz as in spec)
   - Bandwidth: **80 Hz** (not 100 Hz)

2. **Signal Processing Chain:**
   ```cpp
   d11 = m_iir11.Do(d);          // Bandpass filter at 1080 Hz
   if( d11 < 0.0 ) d11 = -d11;   // Rectify (full-wave)
   d11 = m_lpf11.Do(d11);        // Envelope detector (50 Hz LPF)
   ```

3. **Bit Accumulation Method:**
   - **MSB-first** (NOT LSB-first!)
   - `m_VisData = m_VisData >> 1;`  // Shift right
   - `if( d11 > d13 ) m_VisData |= 0x0080;`  // Set bit 7 if mark > space

4. **State Machine Timing:**
   - State 0: Detect leader → State 1, wait 15ms
   - State 1: **Continuously validate** 1200 Hz for 30ms → State 2
   - State 2: Decode 8 bits at 30ms each
   - **Critical**: State 1 resets to State 0 if validation fails at ANY sample

5. **Bit Decision:**
   - Samples **instantaneous** envelope values when 30ms timer expires
   - Does NOT average over entire bit period
   - Compares: `if (d11 > d13)` at one specific moment per bit

## Changes Made to mmsstv-portable

### Applied Fixes:

1. ✅ Changed frequencies from 1100/1300 to **1080/1320 Hz**
2. ✅ Changed bandwidth from 100 to **80 Hz**
3. ✅ Changed bit accumulation from LSB-first to **MSB-first**
4. ✅ Changed timing from blind 100ms wait to **45ms** (15+30)
5. ✅ Changed from averaging to **instantaneous sampling**
6. ✅ Updated LPF smoothing constant from alpha=0.01 to alpha=0.15 (approx 50 Hz)

### Current Status:

**Problem**: All test WAV files extract VIS code **0x00** (all bits read as 0/space/1320Hz)

**Evidence:**
- Space energy consistently > mark energy across all samples
- Example: `mark=0.0075 space=0.0203` (typical during VIS decode)
- One anomalous sample showed `mark=0.0133 space=0.0015` (mark winning!)
- Suggests correct tones exist but timing is misaligned

## Test Results

```
File             VIS Code  Decoded Mode  Expected Mode
----------------------------------------------------------
Robot36C         0x00      varies        0 (R36, should be 0x88)
Martin1          0x00      varies        6 (MRT1, should be 0xAC)
Scottie1         0x00      varies        3 (SCT1, should be 0x3C)
PD90             0x00      varies        12 (PD90, should be 0x63)
```

## Debugging Analysis

### Goertzel Frequency Analysis of Robot36C.wav:

```
Time Range          Dominant Freq   Expected
-------------------------------------------
Leader (0-300ms)    1900 Hz         ✓ Correct
Break (300-310ms)   1200 Hz         ✓ Correct  
Start (310-340ms)   1200 Hz         ✓ Correct
Data bit 0-1        1200 Hz         ✗ Should be 1080/1320!
Data bit 2-4        1100 Hz         ~ Close to 1080
Data bit 5-7        1200 Hz         ✗ Should be 1080/1320!
```

**Interpretation**: The VIS data section appears to have **1200 Hz contamination** or the bit boundaries are misaligned. This suggests:
1. WAV files may have non-standard VIS encoding
2. Timing offset is still incorrect
3. VIS data doesn't start where expected

## Potential Issues

### 1. WAV File Source Unknown
- Files dated Feb 7, 2026 (today) - recently created
- Unknown if generated by MMSSTV or other SSTV software
- Other encoders may use different VIS timing/frequencies

### 2. State Machine Validation
- MMSSTV validates sync continuously during State 1
- mmsstv-portable just blindly waits 45ms
- If WAV has shorter sync or noise, alignment fails

### 3. Filter Initialization
- Filters need settling time after state transitions
- MMSSTV processes all filters every sample (even outside VIS mode)
- mmsstv-portable only processes mark/space during VIS decode

### 4. Timing Precision
- MMSSTV's bit timer counts down per sample
- Bit decision made when timer expires
- Sample timing must align with actual bit transitions in WAV

## Recommendations

### Immediate Actions:

1. **Verify WAV Source**: Confirm these WAV files were generated by MMSSTV
   - If not, generate reference WAVs using actual MMSSTV encoder
   - Test with known-good SSTV signals

2. **Add Continuous Sync Validation**: Implement MMSSTV's State 1 logic
   - Check `sync_energy > leader_energy` every sample during wait period
   - Reset if validation fails

3. **Process Filters Continuously**: Run mark/space filters for all samples
   - Initialize filters at decoder startup
   - Don't reset between state transitions
   - Matches MMSSTV's architecture

4. **Add Detailed Logging**: Create diagnostic mode showing:
   - Sample-by-sample mark/space energies during VIS
   - Exact timing of state transitions
   - Bit decision threshold values

5. **Test with Synthetic Signals**: Create test tone generator
   - Generate perfect VIS sequence: 1900→1200→1080/1320 pattern
   - Verify decoder responds correctly to ideal signal
   - Isolate decoder bugs from WAV file issues

### Implementation Priority:

1. Generate/obtain known-good MMSSTV WAV files
2. Implement continuous filter processing
3. Add State 1 sync validation
4. Create synthetic VIS tone test
5. Fine-tune timing based on working reference

## Code Locations

- VIS decoder: `src/decoder.cpp` lines 326-395
- Filter init: `src/decoder.cpp` lines 169-174  
- Bit accumulation: `src/decoder.cpp` lines 361-371
- Original MMSSTV VIS: `/Users/ssamjung/Desktop/WIP/mmsstv/sstv.cpp` lines 1974-2010
